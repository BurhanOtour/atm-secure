#!/usr/bin/env python2
import socket
import argparse
import sys
import requests
import time

COMMANDSERVER_URL = ''

def worker(conn):
  chunk = b":):):):):):):)"*1000
  while True:
    try:
      conn.send(chunk)
    except:
      signalEnd()
      return


def signalEnd():
  global COMMANDSERVER_URL
  requests.post(COMMANDSERVER_URL, data={"REQUEST": '{"type": "done"}'})

def doProxyMain(port):
  try:
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
    s.bind(("0.0.0.0", port))
    s.listen(1)
    conn, addr = s.accept()
    conn.settimeout(10)
    worker(conn)

    time.sleep(30)

  except KeyboardInterrupt:
    sys.exit(0)

if __name__ == '__main__':
  parser = argparse.ArgumentParser(description='Proxy')
  parser.add_argument('-p', type=int, default=4000, help="listen port")
  parser.add_argument('-s', type=str, default="127.0.0.1", help="server ip address")
  parser.add_argument('-q', type=int, default=3000, help="server port")
  parser.add_argument('-c', type=str, default="127.0.0.1", help="command server")
  parser.add_argument('-d', type=int, default=5000, help="command port")
  args = parser.parse_args()

  COMMANDSERVER_URL = "http://"+args.c+":"+str(args.d)

  print('started\n')
  sys.stdout.flush()
  doProxyMain(args.p)

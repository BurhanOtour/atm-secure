import okio.BufferedSink;
import okio.BufferedSource;
import okio.Okio;

import java.io.IOException;
import java.net.Socket;
import java.util.List;
import java.util.function.Supplier;

public class ReplayInterceptor extends RecordingInterceptor {
    final Supplier<Socket> socketSupplier;
    final List<Integer> replayMessages;
    final int acceptMessageCount;

    public ReplayInterceptor(Supplier<Socket> socketSupplier, List<Integer> replayMessages, int acceptMessageCount) {
        this.socketSupplier = socketSupplier;
        this.replayMessages = replayMessages;
        this.acceptMessageCount = acceptMessageCount;
    }

    @Override public boolean shouldAcceptNextSocket() {
        return accepted < acceptMessageCount;
    }

    @Override public void onProxyClosed() {
        try {
            for (int replayMessage : replayMessages) {
                System.err.println("Replaying message " + replayMessage);

                Socket forwardSocket = socketSupplier.get();
                try (
                    BufferedSource forwardIn = Okio.buffer(Okio.source(forwardSocket));
                    BufferedSink forwardOut = Okio.buffer(Okio.sink(forwardSocket))) {
                    forwardOut.write(getClientToServerBytes().get(replayMessage));
                    forwardOut.writeByte('\n');
                    forwardOut.flush();
                    forwardIn.readByteArray();
                }
            }
        } catch (IOException e) {
            throw new RuntimeException(e);
        }
    }

    @Override
    public boolean clientToServer(byte[] bytes, BufferedSink replySink, BufferedSink forwardSink) throws IOException {
        System.err.print("Message no: " + accepted + " ");
        return super.clientToServer(bytes, replySink, forwardSink);
    }

    @Override
    public boolean serverToClient(byte[] bytes, BufferedSink replySink, BufferedSink forwardSink) throws IOException {
        System.err.print("Message no: " + accepted + " ");
        return super.serverToClient(bytes, replySink, forwardSink);
    }
}

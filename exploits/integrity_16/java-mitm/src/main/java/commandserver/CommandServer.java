package commandserver;

import com.squareup.moshi.Moshi;
import models.Response;
import okhttp3.HttpUrl;
import okhttp3.MediaType;
import okhttp3.OkHttpClient;
import okhttp3.Request;
import okhttp3.RequestBody;
import okio.BufferedSource;

import java.io.IOException;
import java.util.concurrent.TimeUnit;

public class CommandServer {
    private final HttpUrl url;
    private final OkHttpClient httpClient = new OkHttpClient.Builder()
        .connectTimeout(10, TimeUnit.SECONDS)
        .readTimeout(10, TimeUnit.SECONDS)
        .writeTimeout(10, TimeUnit.SECONDS)
        .build();
    private final Moshi moshi = new Moshi.Builder().build();

    public CommandServer(String commandHost, int commandPort) {
        url = new HttpUrl.Builder()
            .scheme("http")
            .host(commandHost)
            .port(commandPort)
            .build();
    }

    public Response send(Object command) {
        String json = moshi.<Object>adapter(command.getClass()).toJson(command);
        Request request = new Request.Builder()
            .post(RequestBody.create(MediaType.parse("application/json"), json))
            .url(url)
            .build();
        for (int i = 0; ; i++) {
            try {
                okhttp3.Response httpResponse = httpClient.newCall(request).execute();
                try (BufferedSource source = httpResponse.body().source()) {
                    return moshi.adapter(Response.class).fromJson(source);
                }
            } catch (IOException e) {
                if (i == 2) {
                    throw new RuntimeException(e);
                } else {
                    try {
                        Thread.sleep(200);
                    } catch (InterruptedException e1) {
                        throw new RuntimeException(e1);
                    }
                }
            }
        }
    }
}
